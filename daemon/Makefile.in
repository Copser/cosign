################## Some of this may need to be edited ##################

prefix=@prefix@
exec_prefix=@exec_prefix@
SBINDIR=@sbindir@
MANDIR=@mandir@

COSIGNCONF=@cosignconf@
COSIGNDB=@cosigndb@
COSIGNCADIR=@cosigncadir@
COSIGNCERT=@cosigncert@
COSIGNKEY=@cosignkey@
COSIGNSYSLOG=LOG_LOCAL7

INCPATH=        @CPPFLAGS@ -I../libsnet -I../common
OPTOPTS=        @OPTOPTS@
CC=             @CC@
DEFS=           @TLSDEFS@
LIBS=           -lsnet @LIBS@
LDFLAGS=        -L../libsnet/.libs @LDFLAGS@ ${LIBS}
INSTALL=        @INSTALL@

CFLAGS=         ${DEFS} ${OPTOPTS} @CFLAGS@ ${INCPATH}

################ Nothing below should need editing ###################

SRC= daemon.c command.c cparse.c config.c wildcard.c logname.c
COSIGNOBJ= daemon.o command.o cparse.o config.o wildcard.o logname.o \
	../common/argcargv.o ../common/fbase64.o \
	../common/mkcookie.o ../version.o

TARGETS=	cosignd
MANTARGETS=	cosignd.8

all : ${TARGETS}

FRC :

daemon.o : daemon.c
	${CC} ${CFLAGS} \
	-D_COSIGN_CONF=\"${COSIGNCONF}\" \
	-D_COSIGN_DIR=\"${COSIGNDB}\" \
	-D_COSIGN_LOG=${COSIGNSYSLOG} \
	-D_COSIGN_TLS_CADIR=\"${COSIGNCADIR}\" \
	-D_COSIGN_TLS_CERT=\"${COSIGNCERT}\" \
	-D_COSIGN_TLS_KEY=\"${COSIGNKEY}\" \
	-c daemon.c

cosignd : ../libsnet/libsnet.la ${COSIGNOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o cosignd ${COSIGNOBJ} ${LIBPATH} ${LIBS}

man : FRC
	-mkdir tmp
	-mkdir tmp/man
	pwd
	for i in ${MANTARGETS}; do \
	sed -e 's@_COSIGN_CONF@${COSIGNCONF}@g'  \
	-e 's@_COSIGN_DIR@${COSIGNDB}@g' \
	-e 's@_COSIGN_TLS_CADIR@${COSIGNCADIR}@g' \
	-e 's@_COSIGN_TLS_CERT@${COSIGNCERT}@g' \
	-e 's@_COSIGN_TLS_KEY@${COSIGNKEY}@g' \
	$$i > tmp/man/$$i; \
	done

install : all man
	-mkdir -p ${exec_prefix}
	-mkdir -p ${SBINDIR}
	${INSTALL} -m 0755 -c cosignd ${SBINDIR}/
	-mkdir -p ${prefix}
	-mkdir -p ${MANDIR}
	-mkdir ${MANDIR}/man8
	${INSTALL} -m 0644 -c tmp/man/cosignd.8 ${MANDIR}/man8/

clean :
	rm -f a.out core* *.o *.bak *[Ee]rrs tags
	rm -f ${TARGETS}
	rm -rf tmp




