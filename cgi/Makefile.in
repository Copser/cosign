prefix=@prefix@
exec_prefix=@exec_prefix@
SBINDIR=@sbindir@
CGIDIR  = @prefix@/cgi-ssl
DOCROOTDIR  = @prefix@/html
COSIGNCADIR=@cosigncadir@
COSIGNCERT=@cosigncert@
COSIGNKEY=@cosignkey@
COSIGNHOST = @cosignhost@
COSIGNLOGOUTURL = @cosignlogouturl@
KEYTABPATH = @keytabpath@

INCPATH=        @CPPFLAGS@ @KINC@ -I../libsnet -I../libcgi -I../common
OPTOPTS=        @OPTOPTS@
CC=             @CC@
DEFS=           @TLSDEFS@
LIBS=           -lsnet -lcgi @LIBS@ @KLIBS@
LDFLAGS=        -L../libsnet/.libs -L../libcgi @LDFLAGS@ @KLDFLAGS@ ${LIBS}
INSTALL=        @INSTALL@

CFLAGS=         ${DEFS} ${OPTOPTS} @CFLAGS@ ${INCPATH}


OBJ     = network.o ../common/mkcookie.o ../common/fbase64.o ../version.o
CGITARGETS = @BASICCGI@ @KRBCGI@
TARGETS = logout ${CGITARGETS}

all: ${TARGETS}

network.o:	network.c
	${CC} ${CFLAGS} \
	-D_COSIGN_TLS_CADIR=\"${COSIGNCADIR}\" \
	-D_COSIGN_TLS_CERT=\"${COSIGNCERT}\" \
	-D_COSIGN_TLS_KEY=\"${COSIGNKEY}\" \
	-c network.c

cgi.o:	cgi.c
	${CC} ${CFLAGS} \
	-D_COSIGN_HOST=\"${COSIGNHOST}\" \
	-D_KEYTAB_PATH=\"${KEYTABPATH}\" \
	-c cgi.c

basic.o:	basic.c
	${CC} ${CFLAGS} \
	-D_COSIGN_HOST=\"${COSIGNHOST}\" \
	-c basic.c

cosign.cgi: cgi.o $(OBJ)
	${CC} -o cosign.cgi cgi.o $(OBJ) $(LDFLAGS)

basicosign.cgi: basic.o $(OBJ)
	${CC} -o basicosign.cgi basic.o $(OBJ) $(LDFLAGS)

logout.o:	logout.c
	${CC} ${CFLAGS} \
	-D_COSIGN_HOST=\"${COSIGNHOST}\" \
	-D_COSIGN_LOGOUT_URL=\"${COSIGNLOGOUTURL}\" \
	-c logout.c

logout: logout.o $(OBJ)
	${CC} -o logout logout.o $(OBJ) $(LDFLAGS)

clean:
	/bin/rm -rf *.o ${TARGETS}

install : all
	-mkdir -p ${exec_prefix}
	-mkdir -p ${DOCROOTDIR}
	if [ x != x@BASICCGI@ ]; then \
	    ${INSTALL} -m 0755 -c @BASICCGI@ ${DOCROOTDIR}/; \
	fi
	if [ x != x@KRBCGI@ ]; then \
	    ${INSTALL} -m 0755 -c @KRBCGI@ ${DOCROOTDIR}/; \
	    mkdir -p ${CGIDIR}; \
	    ${INSTALL} -m 0755 -c logout ${CGIDIR}/; \
	fi
