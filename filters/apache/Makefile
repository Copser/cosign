##
##  Makefile -- Build procedure for sample cosign Apache module
##  Autogenerated via ``apxs -n cosign -g''.
##

#   the used tools
APXS=apxs
CC=gcc
APACHECTL=apachectl

#   additional user defines, includes and libraries
#DEF=-Dmy_define=my_value
INC=-I/usr/local/openssl/include -I/usr/local/apache/include -I./libsnet
CFLAGS=	${DEF} ${INC} -DEAPI -Wall -Wstrict-prototypes
LIB=-L/usr/local/openssl/lib -lcrypto -L./libsnet -lsnet
OBJ=	mod_cosign.o mkcookie.o fbase64.o connect.o cookiefs.o sparse.o \
	argcargv.o version.o

#   the default target
all: mod_cosign.so

#   compile the DSO file
mod_cosign.so: libsnet/libsnet.a ${OBJ}
	$(APXS) -c $(LIB) ${OBJ}

FRC :

libsnet/libsnet.a : FRC
	cd libsnet; ${MAKE} ${MFLAGS} CC=${CC}

version.o : version.c
	${CC} ${CFLAGS} \
	    -DVERSION=\"`cat VERSION`\" \
	    -c version.c

#   install the DSO file into the Apache installation
#   and activate it in the Apache configuration
install: all
	$(APXS) -i -a -n 'cosign' mod_cosign.so

VERSION=`date +%Y%m%d`
DISTDIR=../mod_cosign-${VERSION}

dist   : clean
	mkdir ${DISTDIR}
	tar chfFFX - EXCLUDE . | ( cd ${DISTDIR}; tar xvf - )
	chmod +w ${DISTDIR}/Makefile
	echo ${VERSION} > ${DISTDIR}/VERSION

#   cleanup
clean:
	cd libsnet; ${MAKE} ${MFLAGS} clean
	rm -f ${OBJ} mod_cosign.so

#   reload the module by installing and restarting Apache
reload: install restart

#   the general Apache start/restart/stop procedures
start:
	$(APACHECTL) start
restart:
	$(APACHECTL) restart
stop:
	$(APACHECTL) stop

